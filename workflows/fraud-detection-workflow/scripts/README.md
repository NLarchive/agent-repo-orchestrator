# Test Report Generation

## Overview

The Test Report Generator automatically consumes test results and code coverage data to produce comprehensive HTML (and optional PDF) reports. This enables easy tracking of test execution metrics and coverage trends over time.

## Features

- **Test Summary**: Total tests, pass/fail counts, pass rate, test duration
- **Code Coverage Analysis**: Statement, branch, function, and line coverage percentages
- **Detailed Test Results**: Individual test cases with pass/fail status and execution time
- **Coverage by File**: Detailed breakdown of coverage metrics per source file
- **Multiple Output Formats**: HTML (default) and PDF options
- **CI/CD Integration**: Easy npm scripts for automated report generation

## Installation

The report generator requires Node.js 14+ and is included in the project dependencies. Optional PDF support requires Puppeteer:

```bash
# Already installed
npm install

# Optional: For PDF support
npm install puppeteer
```

## Usage

### Generate HTML Report

```bash
npm run report
```

### Generate PDF Report

```bash
npm run report:pdf
```

### Generate Both HTML and PDF

```bash
npm run report:both
```

### Manual Invocation

```bash
node workflows/fraud-detection-workflow/scripts/generate-test-report.js [options]
```

**Options:**
- `--input <path>`: Path to test results directory (default: `workflows/fraud-detection-workflow`)
- `--output <path>`: Output directory for reports (default: `workflows/fraud-detection-workflow/reports`)
- `--format <format>`: Output format: `html`, `pdf`, or `both` (default: `html`)

### Examples

```bash
# Generate HTML report with custom paths
node scripts/generate-test-report.js \
  --input ./test-results \
  --output ./reports \
  --format html

# Generate both HTML and PDF
node scripts/generate-test-report.js \
  --input ./test-results \
  --output ./reports \
  --format both
```

## Input Files

The report generator expects:

1. **Test Results**: `<input-dir>/test-results.json`
   - Generated by Jest with: `jest --coverage --json --outputFile=test-results.json`
   - Contains test execution metrics and individual test results

2. **Coverage Data**: `../../coverage/coverage-final.json`
   - Generated by Jest coverage collection
   - Contains per-file statement, branch, function, and line coverage data

## Output

Reports are generated in the specified output directory:

- `test-report-YYYY-MM-DD.html` - Comprehensive HTML report (always generated)
- `test-report-YYYY-MM-DD.pdf` - PDF version (optional, requires Puppeteer)

## Report Contents

### Report Header
- Report generation date and time
- Test start time
- Total execution duration
- Overall pass rate

### Test Summary Section
- Total tests, passed, failed, pending
- Test pass rate percentage
- Test suite statistics

### Code Coverage Section
- Overall coverage metrics (statements, branches, functions, lines)
- Per-file coverage breakdown (top 20 files by lowest coverage)
- Files sorted by coverage to highlight gaps

### Test Results Section
- Individual test cases with status indicators
- Test hierarchy (suites â†’ test cases)
- Execution times per test
- Failure messages (if any)

## Color Coding

Coverage percentages use color indicators:
- ðŸŸ¢ **Green** (â‰¥90%): Excellent coverage
- ðŸŸ¡ **Yellow** (80-89%): Good coverage
- ðŸŸ  **Orange** (70-79%): Acceptable coverage
- ðŸ”´ **Red** (<70%): Low coverage

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Test and Report

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Generate reports
        if: always()
        run: npm run report
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: workflows/fraud-detection-workflow/reports/
          retention-days: 30
```

### GitLab CI Example

```yaml
test_and_report:
  image: node:18
  stage: test
  script:
    - npm ci
    - npm test
    - npm run report
  artifacts:
    paths:
      - workflows/fraud-detection-workflow/reports/
    when: always
    expire_in: 30 days
```

### Local CI Integration

Add to your build pipeline before artifact upload:

```bash
#!/bin/bash
set -e

# Run tests
npm test

# Generate reports
npm run report

# Optional: Generate PDF (requires Puppeteer)
# npm run report:pdf

# Upload artifacts (example for AWS S3)
# aws s3 cp workflows/fraud-detection-workflow/reports/ s3://my-bucket/reports/ --recursive
```

## Data Schema

### Test Results JSON Structure

```json
{
  "numTotalTests": 37,
  "numPassedTests": 37,
  "numFailedTests": 0,
  "numPendingTests": 0,
  "numTotalTestSuites": 1,
  "numPassedTestSuites": 1,
  "numFailedTestSuites": 0,
  "startTime": 1234567890,
  "endTime": 1234567900,
  "testResults": [
    {
      "name": "path/to/test-file.js",
      "status": "passed",
      "assertionResults": [
        {
          "title": "test description",
          "status": "passed",
          "duration": 10,
          "failureMessages": []
        }
      ]
    }
  ]
}
```

### Coverage Data JSON Structure

```json
{
  "path/to/file.js": {
    "path": "path/to/file.js",
    "s": { "0": 5, "1": 3, ... },    // Statement counts
    "b": { "0": [3, 1], ... },      // Branch counts
    "f": { "0": 2, ... },            // Function counts
    "l": { "1": 5, "2": 3, ... }    // Line counts
  }
}
```

## Customization

To customize the HTML report template, edit the `generateHTMLReport()` function in `generate-test-report.js`:

- **Styling**: Modify the `<style>` section (lines 200-400)
- **Layout**: Modify the HTML structure in the return statement
- **Metrics**: Add/remove metric cards or sections
- **Colors**: Update `getCoverageColor()` function thresholds

## Troubleshooting

### "Test results file not found"
Ensure Jest was run with: `npm test` (which automatically generates coverage)

### PDF generation fails
Install Puppeteer: `npm install puppeteer`

### Large file sizes
HTML reports include embedded styling and can be large. Remove unused test results if needed.

### Coverage percentages don't match
Coverage is calculated from all files in coverage-final.json. Ensure Jest coverage collection is enabled in jest.config.js:

```javascript
module.exports = {
  collectCoverage: true,
  collectCoverageFrom: ['src/**/*.js'],
};
```

## Performance

- HTML generation: <1 second
- PDF generation (with Puppeteer): 2-5 seconds
- Report includes up to 20 files in coverage table

## License

Same as parent project (MIT)

<!-- Nicolas Larenas, nlarchive -->
